<!DOCTYPE html>
<html lang="en-us">
  <head>
    
<meta charset="UTF-8">
<title>Leverage Workplace Search document-level permissions in your search engine | Enterprise Search documentation [main] | Elastic</title>
<meta class="elastic" name="content" content="Leverage Workplace Search document-level permissions in your search engine | Enterprise Search documentation [main]">

<link rel="home" href="index.html" title="Enterprise Search documentation [main]"/>
<link rel="up" href="engines.html" title="Indices, engines, meta engines, and content sources"/>
<link rel="prev" href="unified-search.html" title="Search across Elasticsearch indices, App Search engines, and Workplace Search content sources"/>
<link rel="next" href="programming-language-clients.html" title="Programming language clients"/>
<meta class="elastic" name="product_version" content="main"/>
<meta class="elastic" name="product_name" content="Enterprise Search"/>
<meta class="elastic" name="website_area" content="documentation"/>
<meta name="DC.type" content="Learn/Docs/Enterprise Search/Guide/main"/>
<meta name="DC.subject" content="Enterprise Search"/>
<meta name="DC.identifier" content="main"/>

    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <script src="https://cdn.optimizely.com/js/18132920325.js"></script>
    <link rel="apple-touch-icon" sizes="57x57" href="/apple-icon-57x57.png">
    <link rel="apple-touch-icon" sizes="60x60" href="/apple-icon-60x60.png">
    <link rel="apple-touch-icon" sizes="72x72" href="/apple-icon-72x72.png">
    <link rel="apple-touch-icon" sizes="76x76" href="/apple-icon-76x76.png">
    <link rel="apple-touch-icon" sizes="114x114" href="/apple-icon-114x114.png">
    <link rel="apple-touch-icon" sizes="120x120" href="/apple-icon-120x120.png">
    <link rel="apple-touch-icon" sizes="144x144" href="/apple-icon-144x144.png">
    <link rel="apple-touch-icon" sizes="152x152" href="/apple-icon-152x152.png">
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-icon-180x180.png">
    <link rel="icon" type="image/png" href="/favicon-32x32.png" sizes="32x32">
    <link rel="icon" type="image/png" href="/android-chrome-192x192.png" sizes="192x192">
    <link rel="icon" type="image/png" href="/favicon-96x96.png" sizes="96x96">
    <link rel="icon" type="image/png" href="/favicon-16x16.png" sizes="16x16">
    <link rel="manifest" href="/manifest.json">
    <meta name="apple-mobile-web-app-title" content="Elastic">
    <meta name="application-name" content="Elastic">
    <meta name="msapplication-TileColor" content="#ffffff">
    <meta name="msapplication-TileImage" content="/mstile-144x144.png">
    <meta name="theme-color" content="#ffffff">
    <meta name="naver-site-verification" content="936882c1853b701b3cef3721758d80535413dbfd" />
    <meta name="yandex-verification" content="d8a47e95d0972434" />
    <meta name="localized" content="true" />
    <meta name="st:robots" content="follow,index" />
    <meta property="og:image" content="https://static-www.elastic.co/v3/assets/bltefdd0b53724fa2ce/blt280217a63b82a734/6202d3378b1f312528798412/elastic-logo.svg" />
    <meta property="og:image:width" content="500" />
    <meta property="og:image:height" content="172" />
    <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon">
    <link rel="icon" href="/favicon.ico" type="image/x-icon">
    <link rel="apple-touch-icon-precomposed" sizes="64x64" href="/favicon_64x64_16bit.png">
    <link rel="apple-touch-icon-precomposed" sizes="32x32" href="/favicon_32x32.png">
    <link rel="apple-touch-icon-precomposed" sizes="16x16" href="/favicon_16x16.png">
    <!-- Give IE8 a fighting chance -->
    <!--[if lt IE 9]>
    <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
    <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->
    <link rel="stylesheet" type="text/css" href="/guide/static/styles.css" />
  </head>

  <!--© 2015-2022 Elasticsearch B.V. -->
  <!-- All Elastic documentation is licensed under a Creative Commons Attribution-NonCommercial-NoDerivatives 4.0 International License. -->
  <!-- http://creativecommons.org/licenses/by-nc-nd/4.0/ -->

  <body>
    <!-- Google Tag Manager -->
    <script>dataLayer = [];</script><noscript><iframe src="//www.googletagmanager.com/ns.html?id=GTM-58RLH5" height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
    <script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start': new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0], j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src= '//www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f); })(window,document,'script','dataLayer','GTM-58RLH5');</script>
    <!-- End Google Tag Manager -->

    <!-- Global site tag (gtag.js) - Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-12395217-16"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'UA-12395217-16');
    </script>

    <!-- Google Tag Manager for GA4 -->
    <script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start': new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0], j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src='https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);})(window,document,'script','dataLayer','GTM-KNJMG2M');</script>
    <noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-KNJMG2M" height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
    <!-- End Google Tag Manager for GA4-->

    <!--BEGIN QUALTRICS WEBSITE FEEDBACK SNIPPET-->
    <script type='text/javascript'>
      (function(){var g=function(e,h,f,g){
      this.get=function(a){for(var a=a+"=",c=document.cookie.split(";"),b=0,e=c.length;b<e;b++){for(var d=c[b];" "==d.charAt(0);)d=d.substring(1,d.length);if(0==d.indexOf(a))return d.substring(a.length,d.length)}return null};
      this.set=function(a,c){var b="",b=new Date;b.setTime(b.getTime()+6048E5);b="; expires="+b.toGMTString();document.cookie=a+"="+c+b+"; path=/; "};
      this.check=function(){var a=this.get(f);if(a)a=a.split(":");else if(100!=e)"v"==h&&(e=Math.random()>=e/100?0:100),a=[h,e,0],this.set(f,a.join(":"));else return!0;var c=a[1];if(100==c)return!0;switch(a[0]){case "v":return!1;case "r":return c=a[2]%Math.floor(100/c),a[2]++,this.set(f,a.join(":")),!c}return!0};
      this.go=function(){if(this.check()){var a=document.createElement("script");a.type="text/javascript";a.src=g;document.body&&document.body.appendChild(a)}};
      this.start=function(){var a=this;window.addEventListener?window.addEventListener("load",function(){a.go()},!1):window.attachEvent&&window.attachEvent("onload",function(){a.go()})}};
      try{(new g(100,"r","QSI_S_ZN_emkP0oSe9Qrn7kF","https://znemkp0ose9qrn7kf-elastic.siteintercept.qualtrics.com/WRSiteInterceptEngine/?Q_ZID=ZN_emkP0oSe9Qrn7kF")).start()}catch(i){}})();
    </script><div id='ZN_emkP0oSe9Qrn7kF'><!--DO NOT REMOVE-CONTENTS PLACED HERE--></div>
    <!--END WEBSITE FEEDBACK SNIPPET-->

    <div id='elastic-nav' style="display:none;"></div>
    <script src='https://www.elastic.co/elastic-nav.js'></script>

    <div class="main-container">
      <section id="content" >
        <div class="content-wrapper">

          <section id="guide" lang="en">
            <div class="container-fluid">
              <div class="row pb-3">
                <div class="col-12 order-2 col-md-4 order-md-1 col-lg-3 h-almost-full-md sticky-top-md" id="left_col">
                  <!-- The TOC is appended here -->
                </div>

                <div class="col-12 order-1 col-md-8 order-md-2 col-lg-7 order-lg-2 guide-section" id="middle_col">
                  <!-- start body -->
                  <div class="page_header">
You are looking at preliminary documentation for a future release.
Not what you want? See the
<a href="../current/index.html">current release documentation</a>.
</div>
<div id="content">
<div class="breadcrumbs">
<span class="breadcrumb-link"><a href="/guide/">Elastic Docs</a></span>
<span class="chevron-right">›</span><span class="breadcrumb-link"><a href="index.html">Enterprise Search documentation [main]</a></span>
<span class="chevron-right">›</span><span class="breadcrumb-link"><a href="engines.html">Indices, engines, meta engines, and content sources</a></span>
</div>
<div class="navheader">
<span class="prev">
<a href="unified-search.html">« Search across Elasticsearch indices, App Search engines, and Workplace Search content sources</a>
</span>
<span class="next">
<a href="programming-language-clients.html">Programming language clients »</a>
</span>
</div>
<div class="chapter">
<div class="titlepage"><div><div>
<h2 class="title"><a id="engines-workplace-search-dlp"></a>Leverage Workplace Search document-level permissions in your search engine<a class="edit_me edit_me_private" rel="nofollow" title="Editing on GitHub is available to Elastic" href="https://github.com/elastic/enterprise-search-pubs/edit/main/enterprise-search-docs/workplace-search-dlp-engines.asciidoc">edit</a></h2>
</div></div></div>

<p><a class="xref" href="unified-search.html#unified-search-engines-content-sources-indices" title="Engines, content sources, and indices">Engines, content sources, and indices</a> explains how to combine content in Workplace Search content sources with content from App Search engines and Elasticsearch indices, to create a unified search experience.</p>
<p>However, you may need to preserve <a href="/guide/en/workplace-search/main/workplace-search-sources-document-permissions.html" class="ulink" target="_blank" rel="noopener">Workplace Search&#8217;s document-level permissions (DLP)</a> for your documents, when working with engines and indices.</p>
<p>This document explains one way to do this, using <a href="/guide/en/app-search/main/authentication.html#authentication-signed" class="ulink" target="_blank" rel="noopener">App Search signed search keys</a>.</p>
<p>In this example we will:</p>
<div class="olist orderedlist">
<ol class="orderedlist">
<li class="listitem">
Set up a Workplace Search deployment with a collection of documents that have DLP configured.
</li>
<li class="listitem">
Use the <a href="/guide/en/workplace-search/main/workplace-search-external-identities-api.html" class="ulink" target="_blank" rel="noopener">external identities API</a> to map users from Microsoft to Workplace Search.
</li>
<li class="listitem">
Create an App Search <a href="/guide/en/app-search/main/elasticsearch-engines.html" class="ulink" target="_blank" rel="noopener">Elasticsearch index engine</a> from your Workplace Search content.
</li>
<li class="listitem">
Use <a href="/guide/en/app-search/main/authentication.html#authentication-signed" class="ulink" target="_blank" rel="noopener">App Search signed search keys</a> to restrict what search results are served to users, based on their Workplace Search permissions.
</li>
</ol>
</div>
<h3><a id="engines-workplace-search-dlp-content-setup"></a>Set up content source in Workplace Search<a class="edit_me edit_me_private" rel="nofollow" title="Editing on GitHub is available to Elastic" href="https://github.com/elastic/enterprise-search-pubs/edit/main/enterprise-search-docs/workplace-search-dlp-engines.asciidoc">edit</a></h3>
<p>First, we&#8217;ll set up a Workplace Search deployment with a collection of documents that have DLP configured.
In this example, we&#8217;ll configure and sync a <a href="/guide/en/workplace-search/main/workplace-search-sharepoint-online-connector.html" class="ulink" target="_blank" rel="noopener">SharePoint Online</a> content source.</p>
<p>Complete these steps:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
Follow the instructions in the <a href="/guide/en/workplace-search/main/workplace-search-sharepoint-online-connector.html" class="ulink" target="_blank" rel="noopener">Workplace Search documentation</a> to configure the SharePoint Online connector and connect SharePoint Online to Workplace Search.
</li>
<li class="listitem">
<p>Enable DLP for the content source.</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
Refer to <a href="/guide/en/workplace-search/main/workplace-search-sources-document-permissions.html#sources-permissions-microsoft" class="ulink" target="_blank" rel="noopener">DLP for Microsoft</a> in the Workplace Search documentation for details.
</li>
</ul>
</div>
</li>
</ul>
</div>
<div class="note admon">
<div class="icon"></div>
<div class="admon_content">
<p>We use the SharePoint Online connector in this concrete example.
Refer to <a href="/guide/en/workplace-search/main/workplace-search-sources-document-permissions.html#sources-permissions-first-party" class="ulink" target="_blank" rel="noopener">Managing document access &amp; permissions</a> for details about other content sources.</p>
</div>
</div>
<h4><a id="engines-workplace-search-dlp-gather-details"></a>Gather details<a class="edit_me edit_me_private" rel="nofollow" title="Editing on GitHub is available to Elastic" href="https://github.com/elastic/enterprise-search-pubs/edit/main/enterprise-search-docs/workplace-search-dlp-engines.asciidoc">edit</a></h4>
<p>Once your SharePoint Online content source is connected, you&#8217;ll need to keep some details handy.</p>
<p>Note the following details:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
<span class="strong strong"><strong>Microsoft Office 365</strong></span> Groups user IDs
</li>
<li class="listitem">
<span class="strong strong"><strong>Workplace Search</strong></span> usernames
</li>
<li class="listitem">
<span class="strong strong"><strong>User mappings</strong></span> from Microsoft IDs to Workplace Search usernames
</li>
<li class="listitem">
<a href="/guide/en/workplace-search/main/workplace-search-sources-document-permissions.html#sources-permissions-content-source-id-token" class="ulink" target="_blank" rel="noopener"><span class="strong strong"><strong>Content source ID</strong></span> and <span class="strong strong"><strong>bearer token</strong></span></a>
</li>
</ul>
</div>
<p>You&#8217;ll need these details to complete the API calls to the external identities endpoint.</p>
<h3><a id="engines-workplace-search-dlp-mapping"></a>User mappings<a class="edit_me edit_me_private" rel="nofollow" title="Editing on GitHub is available to Elastic" href="https://github.com/elastic/enterprise-search-pubs/edit/main/enterprise-search-docs/workplace-search-dlp-engines.asciidoc">edit</a></h3>
<p>When you connect your SharePoint Online content source, you’ll be asked to use the <span class="strong strong"><strong>external identities API</strong></span> to finalize the mapping between Microsoft users and Workplace Search users.
Send one API request for each user mapping, per <span class="strong strong"><strong>content source ID</strong></span>.</p>
<p>Refer to the following example API calls for guidance.</p>
<h4><a id="engines-workplace-search-dlp-mapping-examples"></a>Example API calls<a class="edit_me edit_me_private" rel="nofollow" title="Editing on GitHub is available to Elastic" href="https://github.com/elastic/enterprise-search-pubs/edit/main/enterprise-search-docs/workplace-search-dlp-engines.asciidoc">edit</a></h4>
<h5><a id="engines-workplace-search-dlp-mapping-examples-map-user"></a>Map users<a class="edit_me edit_me_private" rel="nofollow" title="Editing on GitHub is available to Elastic" href="https://github.com/elastic/enterprise-search-pubs/edit/main/enterprise-search-docs/workplace-search-dlp-engines.asciidoc">edit</a></h5>
<p>Map an external user ID to a Workplace Search username:</p>
<div class="pre_wrapper lang-bash">
<pre class="programlisting prettyprint lang-bash">curl -X POST https://my-deployment.ent.us-west2.gcp.elastic-cloud.com/api/ws/v1/sources/&lt;CONTENT-SOURCE-ID&gt;/external_identities \
-H "Authorization: Bearer &lt;YOUR-API-KEY&gt;" \
-H "Content-Type: application/json" \
-d '{
    "external_user_id": "75e1766a-f83d-48f8-aac3-8422f5cea411",
     "external_user_properties": [{
        "attribute_name": "_elasticsearch_username",
        "attribute_value": "Jane-Doe"
        }],
    "permissions": []
 }'</pre>
</div>
<p>A successful response looks like this:</p>
<div class="pre_wrapper lang-json">
<pre class="programlisting prettyprint lang-json">{
  "content_source_id": "&lt;CONTENT-SOURCE-ID&gt;",
  "external_user_id": "75e1766a-f83d-48f8-aac3-8422f5cea411",
  "external_user_properties": [
    {
      "attribute_name": "_elasticsearch_username",
      "attribute_value": "Jane-Doe"
    }
  ],
  "permissions": []
}</pre>
</div>
<h5><a id="engines-workplace-search-dlp-mapping-examples-map-user-confirm"></a>Confirm mapping<a class="edit_me edit_me_private" rel="nofollow" title="Editing on GitHub is available to Elastic" href="https://github.com/elastic/enterprise-search-pubs/edit/main/enterprise-search-docs/workplace-search-dlp-engines.asciidoc">edit</a></h5>
<p>Confirm that the mapping was created with a GET request:</p>
<div class="pre_wrapper lang-bash">
<pre class="programlisting prettyprint lang-bash">curl -X GET https://my-deployment.ent.us-west2.gcp.elastic-cloud.com/api/ws/v1/sources/&lt;CONTENT-SOURCE-ID&gt;/external_identities \
-H "Authorization: Bearer &lt;YOUR-API-KEY&gt;"</pre>
</div>
<details>
<summary class="title">Expand to see an <span class="strong strong"><strong>example response</strong></span></summary>
<div class="content">
<div class="pre_wrapper lang-json">
<pre class="programlisting prettyprint lang-json">{
  "meta": {
    "page": {
      "current": 1,
      "total_pages": 1,
      "total_results": 2,
      "size": 25
    }
  },
  "results": [
    {
      "content_source_id": "&lt;CONTENT-SOURCE-ID&gt;",
      "external_user_id": "75e1766a-f83d-48f8-aac3-8422f5cea411",
      "external_user_properties": [
        {
          "attribute_name": "_elasticsearch_username",
          "attribute_value": "Jane-Doe"
        }
      ],
      "permissions": []
    }
  ]
}</pre>
</div>
</div>
</details>
<h5><a id="engines-workplace-search-dlp-mapping-examples-confirm-permissions"></a>Confirm permissions after sync<a class="edit_me edit_me_private" rel="nofollow" title="Editing on GitHub is available to Elastic" href="https://github.com/elastic/enterprise-search-pubs/edit/main/enterprise-search-docs/workplace-search-dlp-engines.asciidoc">edit</a></h5>
<p>Now that the mapping is in place, launch a sync to populate your documents with the permissions.
Once the sync is complete, send a GET request to confirm that the permissions are in place.</p>
<div class="pre_wrapper lang-bash">
<pre class="programlisting prettyprint lang-bash">curl -X GET https://my-deployment.ent.us-west2.gcp.elastic-cloud.com/api/ws/v1/sources/&lt;CONTENT-SOURCE-ID&gt;/external_identities \
-H "Authorization: Bearer &lt;YOUR-API-KEY&gt;"</pre>
</div>
<p>A successful response will return a populated permissions field.</p>
<details>
<summary class="title"><span class="strong strong"><strong>Expand</strong></span> to see an <span class="strong strong"><strong>example response</strong></span></summary>
<div class="content">
<div class="pre_wrapper lang-json">
<pre class="programlisting prettyprint lang-json">{
  "meta": {
    "page": {
      "current": 1,
      "total_pages": 1,
      "total_results": 1,
      "size": 25
    }
  },
  "results": [
    {
      "content_source_id": "63ea2b8b19751bebb90fbed2",
      "external_user_id": "75e1766a-f83d-48f8-aac3-8422f5cea411",
      "external_user_properties": [
        {
          "attribute_name": "_elasticsearch_username",
          "attribute_value": "Jane-Doe"
        }
      ],
      "permissions": [
        "75e1766a-f83d-48f8-aac3-8422f5cea411",
        "PDX Collective Members",
        "78-shared-group Members",
        "Partners Members",
        "MC - Shared Permissions Group Members",
        "Test Site Members",
        "MC - Lower Permissions Group Members",
        "TestGroup38 Members"
      ]
    }
  ]
}</pre>
</div>
</div>
</details>
<h3><a id="engines-workplace-search-dlp-engine"></a>Set up App Search Elasticsearch-index engine<a class="edit_me edit_me_private" rel="nofollow" title="Editing on GitHub is available to Elastic" href="https://github.com/elastic/enterprise-search-pubs/edit/main/enterprise-search-docs/workplace-search-dlp-engines.asciidoc">edit</a></h3>
<p>We want to build an App Search engine based on the Workplace Search content source.
To do this, we need to create an Elasticsearch index-based engine.</p>
<p>Follow these steps:</p>
<div class="olist orderedlist">
<ol class="orderedlist">
<li class="listitem">
Navigate to <span class="strong strong"><strong>Enterprise Search &gt; App Search &gt; Engines &gt; Create an engine</strong></span>.
</li>
<li class="listitem">
Select <span class="strong strong"><strong>Elasticsearch index-based</strong></span> engine type.
</li>
<li class="listitem">
Name the engine.
</li>
<li class="listitem">
Select the <a class="xref" href="engines.html#engines-access-content-source-index" title="Access content source index">Elasticsearch index</a> used by the SharePoint Online content source in Workplace Search.
It requires an alias, prefixed with <code class="literal">search-*</code>, which is set during engine creation.
</li>
<li class="listitem">
Select <span class="strong strong"><strong>Create search engine</strong></span>.
</li>
</ol>
</div>
<h3><a id="engines-workplace-search-dlp-app-search-signed-key"></a>Create an App Search signed API key<a class="edit_me edit_me_private" rel="nofollow" title="Editing on GitHub is available to Elastic" href="https://github.com/elastic/enterprise-search-pubs/edit/main/enterprise-search-docs/workplace-search-dlp-engines.asciidoc">edit</a></h3>
<h4><a id="engines-workplace-search-dlp-app-search-signed-key-overview"></a>Overview<a class="edit_me edit_me_private" rel="nofollow" title="Editing on GitHub is available to Elastic" href="https://github.com/elastic/enterprise-search-pubs/edit/main/enterprise-search-docs/workplace-search-dlp-engines.asciidoc">edit</a></h4>
<p><a href="/guide/en/app-search/main/authentication.html#authentication-signed" class="ulink" target="_blank" rel="noopener">Signed search keys</a> in Elastic App Search give you more control over a user&#8217;s search experience.
They enable you to restrict the data users can see and search over.</p>
<p>App Search has the concept of search keys and private keys:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
A <span class="strong strong"><strong>search</strong></span> key is prefixed with <code class="literal">search-</code> and can only be used to search over engines.
</li>
<li class="listitem">
A <span class="strong strong"><strong>private</strong></span> key is prefixed with <code class="literal">private-</code> and can create, update, and delete documents if the <code class="literal">write</code> flag is enabled.
It can also perform searches and reads if the <code class="literal">read</code> flag is enabled.
</li>
</ul>
</div>
<p>App Search also has the concept of <span class="strong strong"><strong>signed search keys</strong></span>, which can only be used to search.
A signed search key is a JSON Web Token.
It is signed with an API key, ideally a read-only private key, using the HMAC with SHA-256 (HS256) algorithm.</p>
<h4><a id="engines-workplace-search-dlp-app-search-signed-key-create"></a>Create a signed key<a class="edit_me edit_me_private" rel="nofollow" title="Editing on GitHub is available to Elastic" href="https://github.com/elastic/enterprise-search-pubs/edit/main/enterprise-search-docs/workplace-search-dlp-engines.asciidoc">edit</a></h4>
<p>A signed API key has to be signed with a <a href="/guide/en/app-search/main/authentication.html#authentication-search" class="ulink" target="_blank" rel="noopener">public search key</a>.
To build a signed key, you need the name of the key and its value.
Find these details in Kibana, by going to <span class="strong strong"><strong>Enterprise Search &gt; App Search &gt; Credentials</strong></span>.</p>
<p>A signed key will store the user&#8217;s permissions as embedded filters.
We&#8217;ll need to copy the permissions array returned by a GET request to the Workplace Search external identities API.</p>
<p>In this example, the array is:</p>
<div class="pre_wrapper lang-json">
<pre class="programlisting prettyprint lang-json">"permissions": [
        "75e1766a-f83d-48f8-aac3-8422f5cea411",
        "PDX Collective Members",
        "78-shared-group Members",
        "Partners Members",
        "MC - Shared Permissions Group Members",
        "Test Site Members",
        "MC - Lower Permissions Group Members",
        "TestGroup38 Members"
      ]</pre>
</div>
<div class="tip admon">
<div class="icon"></div>
<div class="admon_content">
<p>Permissions are populated by the Workplace Search permissions sync that by default runs every 5 minutes.
For a newly created external identity we recommend waiting for a permission sync to run, before retrieving the permissions via API.</p>
</div>
</div>
<p>Now, we can create a signed key with the permissions array as the embedded filters.</p>
<p>The signed payload of the JWT looks like this:</p>
<div class="pre_wrapper lang-json">
<pre class="programlisting prettyprint lang-json">{
  "filters": {
    "any": [
      {
        "_allow_permissions": {{permissions_array}}
      }
    ]
  },
  "api_key_name": {{name-of-search-key}}
}</pre>
</div>
<p>In our example, the payload looks like this:</p>
<div class="pre_wrapper lang-json">
<pre class="programlisting prettyprint lang-json">{
  "filters": {
    "any": [
      {
        "_allow_permissions": [
          "75e1766a-f83d-48f8-aac3-8422f5cea411",
          "PDX Collective Members",
          "78-shared-group Members",
          "Partners Members",
          "MC - Shared Permissions Group Members",
          "Test Site Members",
          "MC - Lower Permissions Group Members",
          "TestGroup38 Members"
        ]
      }
    ]
  },
  "api_key_name": "search-key"
}</pre>
</div>
<p>The payload will be signed with the value of the public search key.
There are various tools and libraries to create signed JWT.</p>
<div class="tip admon">
<div class="icon"></div>
<div class="admon_content">
<p><a href="https://jwt.io/libraries" class="ulink" target="_blank" rel="noopener">jwt.io</a> has a comprehensive list of JWT libraries for many languages.</p>
</div>
</div>
<p>Here is an example in Ruby:</p>
<div class="pre_wrapper lang-ruby">
<pre class="programlisting prettyprint lang-ruby">require 'jwt'

key_name = 'search-key'
permissions = [
  "75e1766a-f83d-48f8-aac3-8422f5cea411",
  "PDX Collective Members",
  "78-shared-group Members",
  "Partners Members",
  "MC - Shared Permissions Group Members",
  "Test Site Members",
  "MC - Lower Permissions Group Members",
  "TestGroup38 Members"
]

payload = {
 'filters' =&gt;
 { 'any' =&gt; [
     { '_allow_permissions' =&gt; permissions }
   ]
 },
 'api_key_name' =&gt; key_name
}

key_value = 'search-y4bfy8cue3354u894s4vsnnm'
algorithm = 'HS256'

puts JWT.encode(payload, key_value, algorithm)</pre>
</div>
<p>Once created the signed key can be used in the authorization header of search requests.
For example:</p>
<div class="pre_wrapper lang-bash">
<pre class="programlisting prettyprint lang-bash">curl -X GET 'https://my-deployment.ent.us-west2.gcp.elastic-cloud.com/api/as/v1/engines/sharepoint-online/search' \
-H 'Content-Type: application/json' \
-H 'Authorization: Bearer eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJmaWx0ZXJzIjp7ImFueSI6W3siX2FsbG93X3Blcm1pc3Npb25zIjpbImJhYTM3YmRhLTBkZDEtNDc5OS1hZTIyLWYzNDc2YzJjZjU4ZCIsIkFkbWluIE1lbWJlcnMiLCJQRFggTWVhdCBDb2xsZWN0aXZlIE1lbWJlcnMiLCJOZXcgc2l0ZSB0ZXN0IE1lbWJlcnMiLCI3OC1zaGFyZWQtZ3JvdXAgTWVtYmVycyIsIlByaXZhdGUgVGVhbSBTaXRlIDA1LTEwIE1lbWJlcnMiLCJNQyAtIFJlc3RyaWN0ZWQgUGVybWlzc2lvbnMgR3JvdXAgTWVtYmVycyIsIkdsb2JhbCBBZG1pbmlzdHJhdG9yIE1lbWJlcnMiLCJMYXJnZSBGaWxlIENvdW50IFNpdGUgKFByaWRlIGFuZCBQcmVqdWRpY2UpIE1lbWJlcnMiLCJNQyAtIFNoYXJlZCBQZXJtaXNzaW9ucyBHcm91cCBNZW1iZXJzIiwiSW9hbmEgQW5vdGhlciBUZXN0IE1lbWJlcnMiLCJUZXN0IFNpdGUgTWVtYmVycyIsIjc4IFRlc3QgbW9vc2VhcHBsZSBNZW1iZXJzIiwiVGVzdEdyb3VwMzggTWVtYmVycyIsIkVuZ2luZWVyaW5nIE1lbWJlcnMiLCJQYXJ0bmVycyBNZW1iZXJzIl19XX0sImFwaV9rZXlfbmFtZSI6InNlYXJjaC1rZXkifQ.wO6U7Iap6h-UqebJ-pKeXtJJlmhI19LQoigZ59IZAJQ' \
-d '{
"query": "guidelines"
}'</pre>
</div>
<h4><a id="engines-workplace-search-dlp-app-search-signed-test-search"></a>Test search results<a class="edit_me edit_me_private" rel="nofollow" title="Editing on GitHub is available to Elastic" href="https://github.com/elastic/enterprise-search-pubs/edit/main/enterprise-search-docs/workplace-search-dlp-engines.asciidoc">edit</a></h4>
<p>Now it&#8217;s time to test that the signed key is working as expected.</p>
<p>Ask the user to issue a search query with the signed API key.
Validate that the documents returned are limited to what was specified in the filters of the API key.
The results should match the permissions listed in the <code class="literal">_allow_permissions</code> field of the documents.</p>
<h3><a id="engines-workplace-search-dlp-workflow"></a>Workflow guidance<a class="edit_me edit_me_private" rel="nofollow" title="Editing on GitHub is available to Elastic" href="https://github.com/elastic/enterprise-search-pubs/edit/main/enterprise-search-docs/workplace-search-dlp-engines.asciidoc">edit</a></h3>
<p>We recommend relying on the Workplace Search permissions sync to automate and keep documents in sync with changes to the original content source&#8217;s user permissions.</p>
<p>In this workflow you will need to handle the generation of the signed API key in the backend of your application, in response to browser sign ins.</p>
<p>Once the key is generated, the backend will also need to return that signed key to the client (browser) to be used in subsequent search requests to your Elastic search engine.</p>
<p>In order to invalidate the signed API keys, you need to invalidate the <span class="strong strong"><strong>public search</strong></span> API key that was used to sign it.</p>
<p>Additionally, if the user&#8217;s permission changes, you&#8217;ll need to recreate the signed search key.</p>
<h3><a id="engines-workplace-search-dlp-learn-more"></a>Learn more<a class="edit_me edit_me_private" rel="nofollow" title="Editing on GitHub is available to Elastic" href="https://github.com/elastic/enterprise-search-pubs/edit/main/enterprise-search-docs/workplace-search-dlp-engines.asciidoc">edit</a></h3>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
<a class="xref" href="unified-search.html" title="Search across Elasticsearch indices, App Search engines, and Workplace Search content sources"><em>Search across indices, engines, and content sources</em></a>
</li>
<li class="listitem">
<a href="/guide/en/workplace-search/main/workplace-search-external-identities-api.html" class="ulink" target="_blank" rel="noopener">Workplace Search external identities API</a>
</li>
<li class="listitem">
<a href="/guide/en/app-search/main/authentication.html#authentication-signed" class="ulink" target="_blank" rel="noopener">App Search signed search keys</a>
</li>
<li class="listitem">
<a href="/guide/en/app-search/main/elasticsearch-engines.html" class="ulink" target="_blank" rel="noopener">App Search Elasticsearch index engines</a>
</li>
<li class="listitem">
<a href="/guide/en/enterprise-search-clients/python/main/connecting.html#auth-as" class="ulink" target="_blank" rel="noopener">Create an App Search signed search key with the Enterprise Search Python client</a>
</li>
</ul>
</div>
</div>
<div class="navfooter">
<span class="prev">
<a href="unified-search.html">« Search across Elasticsearch indices, App Search engines, and Workplace Search content sources</a>
</span>
<span class="next">
<a href="programming-language-clients.html">Programming language clients »</a>
</span>
</div>
</div>

                  <!-- end body -->
                </div>

                <div class="col-12 order-3 col-lg-2 order-lg-3 h-almost-full-lg sticky-top-lg" id="right_col">
                  <div id="sticky_content">
                    <!-- The OTP is appended here -->
                    <div class="row">
                      <div class="col-0 col-md-4 col-lg-0" id="bottom_left_col"></div>
                      <div class="col-12 col-md-8 col-lg-12">
                        <div id="rtpcontainer">
                          <div class="mktg-promo" id="most-popular">
                            <p class="aside-heading">Most Popular</p>
                            <div class="pb-2">
                              <p class="media-type">Video</p>
                              <a href="https://www.elastic.co/webinars/getting-started-elasticsearch?baymax=default&elektra=docs&storm=top-video">
                                <p class="mb-0">Get Started with Elasticsearch</p>
                              </a>
                            </div>
                            <div class="pb-2">
                              <p class="media-type">Video</p>
                              <a href="https://www.elastic.co/webinars/getting-started-kibana?baymax=default&elektra=docs&storm=top-video">
                                <p class="mb-0">Intro to Kibana</p>
                              </a>
                            </div>
                            <div class="pb-2">
                              <p class="media-type">Video</p>
                              <a href="https://www.elastic.co/webinars/introduction-elk-stack?baymax=default&elektra=docs&storm=top-video">
                                <p class="mb-0">ELK for Logs & Metrics</p>
                              </a>
                            </div>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </section>

        </div>


<div id='elastic-footer'></div>
<script src='https://www.elastic.co/elastic-footer.js'></script>
<!-- Footer Section end-->

      </section>
    </div>

<script src="/guide/static/jquery.js"></script>
<script type="text/javascript" src="/guide/static/docs.js"></script>
<script type="text/javascript">
  window.initial_state = {}</script>
  </body>
</html>
